#!/bin/bash

APP_PATH=`pwd`
echo " "
echo "|==========================================|"
echo "|                                          |"
echo "| Welcome in the web-framework framework ! |"
echo "|                                          |"
echo "|       web-framework version 0.1a         |"
echo "|                                          |"
echo "|==========================================|"
echo " "

function compute_classpath()
{
	## Computing of names and classpath with ununderstandable
	
	WAR_NAME=`find $APP_PATH/target -type f -name \*.war`
	WAR_NAME=${WAR_NAME#$APP_PATH/target/} 
	
	APP_NAME=${WAR_NAME%.war}
	
	WEBAPP_PATH=$APP_PATH/target/$APP_NAME
	LIBS=$WEBAPP_PATH/WEB-INF/lib	
	LIBS_CLASSPATH=`find $LIBS -type f -name \*.jar` 
	LIBS_CLASSPATH=`echo $LIBS_CLASSPATH | tr ' ' ':'`
	
	RESOURCES=$APP_PATH/src/main/resources
	CONF=$APP_PATH/src/main/webapp/conf
	
	## end of computing with ununderstandable bash commands
	return
}

function launch() 
{	
	case $1 in
	 "")
	  APP_PATH=`pwd`
	  ;;
	 ".")
	  APP_PATH=`pwd`
	  ;;
	 *)
	  APP_PATH=$1
	  ;;
	esac	
	echo "the application is located @" $APP_PATH
	
	compute_classpath
	
	if (test -e $APP_PATH/target)
	then
		echo " "
		
		rm -rf $APP_PATH/target/compclasses
		mkdir $APP_PATH/target/compclasses
		
		## starting the Grizzly server
		
		java -agentlib:jdwp=transport=dt_socket,address=8000,server=y,suspend=n \
		-classpath $APP_PATH/target/classes:$RESOURCES:$CONF:$LIBS_CLASSPATH \
		cx.ath.mancel01.webframework.integration.grizzly.GrizzlyServerLauncher
		
		## for starting the sun webserver
		
		#cx.ath.mancel01.webframework.integration.httpserver.WebServerLauncher
		
	else
		echo "target not exists. run 'mvn clean install' to prepare application."
		echo " "
		exit 0
	fi
	return
}

function classpath()
{
	compute_classpath
	echo -classpath $WEBAPP_PATH/WEB-INF/classes:$RESOURCES:$CONF:$LIBS_CLASSPATH
	return
}

case $1 in
 new)
  echo "not yet implemented"
  ;;
 run)
  launch $2
  ;;
 classpath)
  classpath
  ;;
 *)
  echo "display the help :)"
  ;;
esac
